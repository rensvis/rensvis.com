name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  qa:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install
        run: npm ci

      - name: Typecheck
        id: typecheck
        run: npx astro check 2>&1 | tee typecheck.log

      - name: Build
        id: build
        run: npm run build 2>&1 | tee build.log

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start preview server
        run: npm run preview &
      - name: Wait for server
        run: npx wait-on http://localhost:4321

      - name: A11y
        id: a11y
        run: npm run test:a11y 2>&1 | tee a11y.log

      - name: Lighthouse
        id: lighthouse
        run: npm run test:lighthouse 2>&1 | tee lhci.log

      - name: CI Summary
        if: always()
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f typecheck.log ]; then
            echo "### Typecheck" >> $GITHUB_STEP_SUMMARY
            FILES=$(grep -oE 'Result \([0-9]+ files\)' typecheck.log | grep -oE '[0-9]+' | head -1)
            echo "✅ ${FILES:-?} files checked" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f build.log ]; then
            echo "### Build" >> $GITHUB_STEP_SUMMARY
            PAGES=$(grep -oE '[0-9]+ page\(s\) built' build.log | grep -oE '[0-9]+' | tail -1)
            TIME=$(grep -oE 'built in [0-9.]+s' build.log | grep -oE '[0-9.]+s' | tail -1)
            echo "✅ ${PAGES:-?} pages in ${TIME:-—}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f a11y.log ]; then
            echo "### A11y" >> $GITHUB_STEP_SUMMARY
            A11Y=$(grep -oE '[0-9]+ passed' a11y.log | head -1)
            echo "✅ ${A11Y:-passed}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f lhci.log ]; then
            echo "### Lighthouse" >> $GITHUB_STEP_SUMMARY
            LHR=$(ls -t .lighthouseci/lhr-*.json 2>/dev/null | head -1)
            if [ -n "$LHR" ] && command -v jq >/dev/null 2>&1; then
              echo "| Category | Score |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
              jq -r '.categories | to_entries[] | "| \(.value.title) | \(.value.score * 100 | floor) |"' "$LHR" 2>/dev/null >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            REPORT_URL=$(grep -oE 'https://storage\.googleapis\.com[^ ]+\.report\.html' lhci.log | head -1)
            if [ -n "$REPORT_URL" ]; then
              echo "[View full report]($REPORT_URL)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
