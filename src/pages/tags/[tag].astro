---
import { getCollection } from 'astro:content';
import PageLayout from '../../layouts/PageLayout.astro';
import ArticleHeader from '../../components/article/ArticleHeader.astro';
import { SITE } from '../../lib/site';

export async function getStaticPaths() {
  const articles = await getCollection('articles');
  const tags = new Set(articles.flatMap((a) => a.data.tags));
  return Array.from(tags).map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;
if (!tag) throw new Error('Tag is required');

const articles = await getCollection('articles', ({ data }) => data.tags.includes(tag));
const sorted = articles.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
---

<PageLayout title={`${tag} | ${SITE.name}`} description={`Articles tagged with ${tag}.`}>
  <main class="container mx-auto max-w-2xl px-4 py-16">
    <h1 class="text-2xl font-bold">Tag: {tag}</h1>
    <p class="mt-2 text-muted-foreground">
      {articles.length} article{articles.length === 1 ? '' : 's'}
    </p>
    <ul class="mt-8 space-y-6">
      {sorted.map((entry) => (
        <li>
          <a href={`/articles/${entry.id}`} class="block rounded-lg border border-border p-4 transition-colors hover:bg-muted/50" aria-label={entry.data.title}>
            <ArticleHeader entry={entry} showDescription />
          </a>
        </li>
      ))}
    </ul>
  </main>
</PageLayout>
